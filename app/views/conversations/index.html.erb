<div class="row">
	<div class="col-lg-6">
		<div class="panel">
			<div  class="horizon_array_menu_h btn_mail">
				<ul>
					<li class="active">	<h2><a href="#btn_inbox" data-toggle="tab"><strong>메세지 목록</strong></a></h2></li>
				</ul>
			</div>	
<<<<<<< HEAD
			
			<div class="conversation_list" style="padding:0 !important;margin-top:54px;">
				<ul class="conversation_list_ul">
					<%@mailbox.conversations.each do |conversation| %>
=======
			<div class="tab-content" style="padding:0 !important;margin-top:54px;">
				<div class="tab-pane fade active in" id="btn_inbox">
					<div class="conversation_list">
						
							
							<ul class="conversation_list_ul">

							<%@mailbox.conversations.each do |conversation| %>
							<% receipts = conversation.receipts_for current_user %>
							<% last_message = receipts.last.message %>
>>>>>>> 6f377510a599462ddca26a37fac8127360ed3450

					<% unless conversation.is_trashed?(current_user) %>

<<<<<<< HEAD
					<% participants = conversation.participants %> <!-- 대화 참여자 -->
					<%p_size = 50 %>
					<% if participants.size  > 2 %>
					<%p_size = 40   %>
					<% is_group = true %>
					<% end %>
					<li class="conversation_list_item">
						<div class="vertical_array_menu c_l_item_subject">
							<ul>
								<li>
									<strong>
										<!-- <%= link_to conversation.last_message.subject, conversation_path(conversation),style:'width:100%;height:25px;position:absolute;color:#000;'%> -->
										<%=time_ago_in_words(conversation.last_message.created_at)%> ago
										<% read_users = who_read_this conversation.last_message %>
										<% unless read_users.size == 0%>
										읽음
=======
							<% participants = conversation.participants %> <!-- 대화 참여자 -->
							<%p_size = 50 %>
							<% if participants.size  > 2 %>
							<%p_size = 40   %>
							<% is_group = true %>
							<% end %>
							<li class="conversation_list_item">
								<div class="vertical_array_menu c_l_item_subject">
									<ul>
										<li>
											<strong>
												<!-- <%= link_to last_message.subject, conversation_path(conversation),style:'width:100%;height:25px;position:absolute;color:#000;'%> -->
												<%=time_ago_in_words(last_message.created_at)%> ago
												
												<!-- <% read_users = who_read_this last_message %> -->
												 
												 
												 
												 <% if is_read?(last_message) %>

												 읽음

												 <% end %>
												 	
												
												 
		
											</strong>
											안 읽은 메세지 : <%=count_unread_message_in conversation %>
										</li> 
										<li>
											<% if current_user?(last_message.sender) %>
											<%=gravatar_for(current_user, size: 20) %>
											<% elsif is_group  %>
											<%=gravatar_for(conversation.last_sender, size: 20) %>
											<%end%>
											<%= link_to last_message.body, conversation_path(conversation),style:'width:100%;position:absolute;top:25px;height:25px;color:#666'%>
											<!-- 위에다가,class:"text_split" 넣으면 이상해진다 -->
										</li>
										
									</ul>
								</div>
								<ol><% participants.each do |participant| %>
									<li>
										
										<%unless current_user?(participant) %> <!-- 나를 제외한 참여자들  얼굴 띄우기 -->

											
										<%=link_to gravatar_for(participant,size: p_size), participant%>
>>>>>>> 6f377510a599462ddca26a37fac8127360ed3450
										<% end %>
									</strong>
									안 읽은 메세지 : <%=count_unread_message_in conversation %>
								</li> 
								<li>
									<span>
										<% if current_user?(conversation.last_message.sender) %>
										<%=gravatar_for(current_user, size: 20) %>
										<% elsif is_group  %>
										<%=gravatar_for(conversation.last_sender, size: 20) %>
										<%end%>
									</span>
									<span>
										<%= link_to conversation.last_message.body, conversation_path(conversation),class:"text_split",style:'width:100%;position:absolute;top:25px;height:25px;color:#666'%>
									</span>
									<!-- 위에다가,class:"text_split" 넣으면 이상해진다 -->
								</li>
							</ul>
						</div>
						<ol>
							<% participants.each do |participant| %>
							<li>										
								<%unless current_user?(participant) %> <!-- 나를 제외한 참여자들  얼굴 띄우기 -->
								<%=link_to gravatar_for(participant,size: p_size), participant%>
								<% end %>
								<!-- <%=link_to gravatar_for(conversation.last_sender,size:50), conversation.last_sender%>  -->
							</li>

							<% end %>
<<<<<<< HEAD
							<li>
								<%= link_to "", trash_conversation_path(conversation),data: { confirm: "휴지통으로 버리시겠습니까?" } ,method: :post,class:'fa fa-trash' %>
							</li>
						</ol>
					</li>
					<% end %>
					<% end %>
				</ul>
=======

							<% end %>


						</ul>
					</div>
				</div>
>>>>>>> 6f377510a599462ddca26a37fac8127360ed3450
			</div>
		</div>
	</div>

	<script>
	var text_split = function(){		
		var text_count = $(".text_split").length;
		for(var i = 0 ; i<=text_count;i++){
			var each_text = $(".text_split:eq("+i+")").text();
			var each_text_length = each_text.length;
			if(each_text_length>=20){
				var text_substr = each_text.substr(0,19)+'...';
				$(".text_split:eq("+i+")").text(text_substr);
			}
		}
	};
	$(text_split);
	$(document).on("page:change",text_split);
	</script>

	<div class="col-lg-6">
		<div class="panel" id="arcodian">
			<div class="panel-heading" style="background-color:#777;">
				<h2 class="accordion-toggle"data-toggle="collapse" data-parent="#accordion" href="#friend_list" style="cursor:pointer; text-align:center;"><strong>친구목록</strong></h2>
			</div>
			<div>
				<% if current_user.following.any? %>
				<ul id="friend_list" class="message_friends_wrap panel-collapse collapse">
					<li>
						<p class="text-danger">이메일을 클릭하세요.</p>
					</li>
					<%= render current_user.following %>
				</ul>
				<% end %>
			</div>
			<%= javascript_tag do %>
			$('.user_email').on('click',function(event){
				var form_val = $('#recipients_form').val();
				var form_val_split =form_val.split(',');
				var form_val_split_length = form_val_split.length;
				var current_user_email = $(event.currentTarget).html();
				for(var i=0; i<form_val_split_length;i++){
					if(form_val===''){
						$('#recipients_form').val($('#recipients_form').val()+current_user_email);
						}else{
							if(form_val_split[i]===current_user_email){
								alert("이미 추가하셨습니다.")
								return;
								}else{
									if(form_val_split_length==i+1){
										$('#recipients_form').val($('#recipients_form').val()+','+current_user_email);
									}					
								}
							}
						}
					});
					<% end %>
					<div class="tab-content">
						<div  class="tab-pane active">
							<%= form_for(:conversation, url: :conversations, method: :post) do |f| %>
							<%= f.label :recipients,'받는사람(친구 목록을 눌러보아요 :)' %>
							<%= f.text_field :recipients,class:"form-control",id:'recipients_form' %>

							<!-- <%= f.label :subject,'제목' %> -->
							<%= f.hidden_field :subject , value: "blanked"  %>

							<%= f.label :body, '전하고 싶은 말', class: "checkbox inline"  %>
							<%= f.text_area :body,class:"form-control" %>         

							<%= f.button '보내기', class: 'btn btn-default' %><!--입력되어진대로 제출한다.-->
							<%= f.button '초기화'	, type: :reset, class: 'btn btn-danger' %><!--입력되어진대로 제출한다.-->
							<!--<%= link_to '뒤로', conversations_path,class:'btn btn-primary'%>-->
							<% end %>
						</div>
					</div>
				</div>
				<div class="panel" id="arcodian">
					<div class="panel-heading" style="background-color:#bbb;">
						<h2 class="accordion-toggle"data-toggle="collapse" data-parent="#accordion" href="#trash" style="cursor:pointer; text-align:center;"><strong>휴지통</strong></h2>
					</div>
					<div>
						<ul id="trash" class="message_friends_wrap panel-collapse collapse">
							<%= render 'trash' %>
						</ul>
					</div>
					
				</div>
			</div>
		</div>


